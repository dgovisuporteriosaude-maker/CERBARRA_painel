<script>
  const REFRESH_INTERVAL_MS = 30000; // 30 segundos
  const DATA_URL = "data/painel_fila_CERBARRA.json";

  const ESPECIALIDADES_CONFIG = {
    "CLINICA MEDICA": { label: "Clínica Médica", prefix: "clinica_medica" },
    "PEDIATRIA": { label: "Pediatria", prefix: "pediatria" },
  };

  const CORES = ["LARANJA", "AMARELO", "VERDE", "AZUL"];

  function fmtTempoMin(min) {
    if (min === null || min === undefined || min <= 0) return "--";
    min = Math.round(min);
    if (min >= 60) {
      const h = Math.floor(min / 60);
      const m = min % 60;
      if (m === 0) return `${h}h`;
      return `${h}h ${m}min`;
    }
    return `${min}min`;
  }

  function renderDashboard(data) {
    // Atualizado em
    document.getElementById("last-updated").textContent = data.gerado_em || "--";

    // Fila de classificação
    const fc = data.fila_classificacao || {};
    document.getElementById("fila-class-qtd").textContent =
      fc.quantidade !== undefined ? fc.quantidade : "--";
    document.getElementById("fila-class-max").textContent = fmtTempoMin(
      fc.tempo_max_espera_min || 0
    );

    const espData = data.especialidades || {};

    // Especialidades (quadrados coloridos)
    for (const [espKey, cfg] of Object.entries(ESPECIALIDADES_CONFIG)) {
      const esp = espData[espKey] || {};
      const prefix = cfg.prefix;

      const por_cor = esp.por_cor || {};
      const max_por_cor = esp.max_espera_por_cor || {};

      // Total da especialidade
      const totalQtdEl = document.getElementById(`${prefix}-total-qtd`);
      const totalMaxEl = document.getElementById(`${prefix}-total-max`);
      if (totalQtdEl) totalQtdEl.textContent = esp.total_fila ?? 0;
      if (totalMaxEl)
        totalMaxEl.textContent = `máx ${fmtTempoMin(esp.tempo_max_espera_min || 0)}`;

      // Por cor
      CORES.forEach((cor) => {
        const idBase = `${prefix}-${cor.toLowerCase()}`;
        const qtdEl = document.getElementById(`${idBase}-qtd`);
        const maxEl = document.getElementById(`${idBase}-max`);
        if (qtdEl) qtdEl.textContent = por_cor[cor] ?? 0;
        if (maxEl)
          maxEl.textContent = `máx ${fmtTempoMin(max_por_cor[cor] || 0)}`;
      });
    }

    // ===== Pacientes críticos =====
    const corPriority = {
      "LARANJA": 1,
      "AMARELO": 2,
      "VERDE": 3,
      "AZUL": 4
    };

    const criticosRaw = data.pacientes_criticos || [];

    // Ordena: cor Manchester primeiro, depois maior tempo
    const criticos = [...criticosRaw].sort((a, b) => {
      const pa = corPriority[a.cor] || 99;
      const pb = corPriority[b.cor] || 99;
      if (pa !== pb) return pa - pb;

      const ta = a.espera_min || 0;
      const tb = b.espera_min || 0;
      return tb - ta; // maior tempo primeiro
    });

    const resumoPorCor = {};
    CORES.forEach((c) => {
      resumoPorCor[c] = { total: 0, porEsp: {} };
    });

    criticos.forEach((p) => {
      const cor = p.cor || "";
      const esp = p.especialidade || "";
      if (!CORES.includes(cor)) return;

      resumoPorCor[cor].total += 1;
      resumoPorCor[cor].porEsp[esp] = (resumoPorCor[cor].porEsp[esp] || 0) + 1;
    });

    // Resumo de críticos
    const resumoDiv = document.getElementById("criticos-resumo");
    resumoDiv.innerHTML = "";
    let temResumo = false;

    CORES.forEach((cor) => {
      const info = resumoPorCor[cor];
      if (!info.total) return;
      temResumo = true;

      const linha = document.createElement("div");
      linha.className = "resumo-linha";

      const partesEsp = Object.entries(info.porEsp).map(([espKey, qtd]) => {
        const cfg = ESPECIALIDADES_CONFIG[espKey];
        const label = cfg ? cfg.label : espKey || "Outros";
        return `${label}: ${qtd}`;
      });

      linha.innerHTML = `
        <span class="resumo-cor">${cor}</span>
        <span class="resumo-total">${info.total} crítico(s)</span>
        <span class="resumo-esps">${partesEsp.join(" • ")}</span>
      `;
      resumoDiv.appendChild(linha);
    });

    if (!temResumo) {
      resumoDiv.innerHTML =
        '<p class="muted">Nenhum paciente em janela crítica no momento.</p>';
    }

    // Lista detalhada
    const listEl = document.getElementById("criticos-lista");
    listEl.innerHTML = "";
    if (!criticos.length) {
      listEl.innerHTML =
        '<li class="muted">Nenhum paciente em tempo crítico no momento.</li>';
    } else {
      criticos.forEach((p) => {
        const li = document.createElement("li");
        const corClass = (p.cor || "").toLowerCase();
        li.className = `critico-item cor-tag-${corClass}`;

        const espCfg = ESPECIALIDADES_CONFIG[p.especialidade];
        const espLabel = espCfg ? espCfg.label : p.especialidade || "";

        const statusHtml = p.estourado
          ? '<span class="status-tag status-estourado">ESTOUROU META</span>'
          : '<span class="status-tag status-critico">CRÍTICO</span>';

        li.innerHTML = `
          <div class="critico-top">
            <span class="critico-boletim">BAE ${p.boletim || "--"}</span>
            <span class="critico-tempo">${p.tempo_espera || "--"}</span>
          </div>
          <div class="critico-nome">${p.paciente || ""}</div>
          <div class="critico-bottom">
            <span class="critico-esp">${espLabel}</span>
            <span class="critico-status">${statusHtml}</span>
          </div>
        `;
        listEl.appendChild(li);
      });
    }
  }

  async function loadData() {
    try {
      const resp = await fetch(`${DATA_URL}?t=${Date.now()}`, { cache: "no-store" });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();
      renderDashboard(data);
    } catch (err) {
      console.error("Erro ao carregar JSON da fila:", err);
    }
  }

  loadData();
  setInterval(loadData, REFRESH_INTERVAL_MS);
</script>
